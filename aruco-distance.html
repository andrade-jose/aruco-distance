<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ArUco Distance Measurement</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #video-container {
            position: relative;
            flex: 1;
            background: #000;
            overflow: hidden;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #controls {
            background: #fff;
            color: #000;
            padding: 20px;
            text-align: center;
        }

        #distance-display {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }

        #status {
            font-size: 16px;
            opacity: 0.7;
            margin-bottom: 10px;
        }

        #instructions {
            font-size: 14px;
            line-height: 1.6;
            max-width: 400px;
            margin: 0 auto;
        }

        .button {
            background: #000;
            color: #fff;
            border: 2px solid #000;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: bold;
        }

        .button:active {
            background: #333;
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #loading.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #error {
            background: #fff;
            color: #000;
            padding: 20px;
            text-align: center;
            display: none;
        }

        #error.show {
            display: block;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div>Carregando...</div>
    </div>

    <div id="error">
        <h2>Erro ao Acessar Câmera</h2>
        <p>Por favor, permita o acesso à câmera do seu dispositivo.</p>
        <button class="button" onclick="location.reload()">Tentar Novamente</button>
    </div>

    <div id="video-container">
        <video id="video" playsinline autoplay></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="controls">
        <div id="distance-display">-- cm</div>
        <div id="status">Procurando marcador ArUco...</div>
        <div id="instructions">
            Aponte a câmera para um marcador ArUco 4x4 (75mm).<br>
            A distância será calculada automaticamente.
        </div>
    </div>

    <script src="https://docs.opencv.org/4.5.2/opencv.js"></script>
    <script>
        // Configurações
        const MARKER_SIZE_CM = 7.5; // Tamanho real do marcador em cm (75mm)
        const ARUCO_DICT = cv.DICT_4X4_50;

        let video, canvas, ctx;
        let streaming = false;
        let processing = false;

        // Inicialização
        function onOpenCvReady() {
            console.log('OpenCV.js carregado');
            document.getElementById('loading').classList.add('hidden');
            initCamera();
        }

        async function initCamera() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Câmera traseira
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });

                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    streaming = true;
                    requestAnimationFrame(processFrame);
                };

            } catch (err) {
                console.error('Erro ao acessar câmera:', err);
                document.getElementById('error').classList.add('show');
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function processFrame() {
            if (!streaming || processing) {
                requestAnimationFrame(processFrame);
                return;
            }

            processing = true;

            try {
                // Captura frame do vídeo
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                let src = cv.imread(canvas);
                let gray = new cv.Mat();
                
                // Converter para escala de cinza
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

                // Detectar marcadores ArUco
                let dictionary = cv.aruco.getPredefinedDictionary(ARUCO_DICT);
                let corners = new cv.MatVector();
                let ids = new cv.Mat();
                let rejected = new cv.MatVector();

                cv.aruco.detectMarkers(gray, dictionary, corners, ids, 
                    new cv.aruco.DetectorParameters());

                // Se encontrou marcadores
                if (ids.rows > 0) {
                    // Desenhar marcadores detectados
                    cv.aruco.drawDetectedMarkers(src, corners, ids);

                    // Calcular distância (método simplificado)
                    const distance = estimateDistance(corners, canvas.width, canvas.height);
                    
                    updateDisplay(distance, ids.rows);
                } else {
                    updateDisplay(null, 0);
                }

                // Mostrar resultado no canvas
                cv.imshow(canvas, src);

                // Limpeza
                src.delete();
                gray.delete();
                corners.delete();
                ids.delete();
                rejected.delete();

            } catch (err) {
                console.error('Erro no processamento:', err);
            }

            processing = false;
            requestAnimationFrame(processFrame);
        }

        function estimateDistance(corners, frameWidth, frameHeight) {
            if (corners.size() === 0) return null;

            // Pegar primeiro marcador detectado
            let corner = corners.get(0);
            
            // Calcular largura do marcador na imagem (em pixels)
            let x1 = corner.data32F[0];
            let y1 = corner.data32F[1];
            let x2 = corner.data32F[2];
            let y2 = corner.data32F[3];
            
            let markerWidthPixels = Math.sqrt(
                Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2)
            );

            // Fórmula simplificada de distância
            // Baseada em: distância = (tamanho_real × focal_length) / tamanho_pixels
            // Assumindo focal_length aproximada baseada na resolução
            const estimatedFocalLength = frameWidth * 1.2; // Aproximação
            const distance = (MARKER_SIZE_CM * estimatedFocalLength) / markerWidthPixels;

            return Math.round(distance);
        }

        function updateDisplay(distance, markerCount) {
            const distanceEl = document.getElementById('distance-display');
            const statusEl = document.getElementById('status');

            if (distance !== null) {
                distanceEl.textContent = `${distance} cm`;
                distanceEl.style.color = '#000';
                statusEl.textContent = `${markerCount} marcador(es) detectado(s)`;
            } else {
                distanceEl.textContent = '-- cm';
                distanceEl.style.color = '#999';
                statusEl.textContent = 'Procurando marcador ArUco...';
            }
        }

        // Carregar OpenCV.js quando disponível
        if (typeof cv !== 'undefined') {
            onOpenCvReady();
        } else {
            document.getElementById('loading').querySelector('div:last-child').textContent = 
                'Carregando biblioteca OpenCV...';
        }
    </script>
</body>
</html>
